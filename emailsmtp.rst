SMTP API
========

Обзор
-----

Платформа Devino Telecom позволяет клиентам отправлять транзакционные (одиночные) email-сообщения с помощью стандартного протокола SMTP. Данный вид интеграции позволит легко подключить CRM, CMS или другую систему к платформе Devino Telecom для отправки email-сообщений вашим клиентам. При отправке сообщений через протокол SMTP платформа DevinoTelecom будет автоматически фильтровать отписавшиеся и hard bounce адреса.

.. warning:: Внимание! Для использования данного вида интеграции необходимо обратиться к своему менеджеру, либо в техническую поддержку support@devinotele.com для настройки доступа.

.. warning:: Внимание! В тексте обязательно должны присутствовать ссылка на отписку и ссылка на веб-версию. 

Подключение
-----------

Для того, чтобы начать отправлять транзакционные email-сообщения по протоколу SMTP, вам необходимо:

* Зарегистрироваться в личном кабинете Devino Telecom.
* Получить SMTP-логин и SMTP-пароль у вашего персонального менеджера, либо через службу технической поддержки
* Сообщить IP-адрес, с которого вы будете подключаться к платформе Devino Telecom, вашему персональному менеджеру, либо службе технической поддержки.
* Прописать в качестве SMTP-сервера для вашего приложения адрес integrationapi.net, порт 587 (TLS), либо 465 (SSL)
* Указать SMTP-логин и SMTP-пароль, полученные на шаге 2.

Отправка: требования и ограничения
----------------------------------

При отправке email-сообщений необходимо соблюдать следующие правила:

* Использовать подтвержденный адрес отправителя (Вы можете запросить адрес отправителя в личном кабинете на странице создания email-рассылки)
* Указывать корректный адрес получателя
* Не отправлять письма, размер которых превышает 500 КБ.
* Не загружать в письмо файлы. Если необходимо отправить файл, то вы можете указать на него ссылкой.
* Не указывать в поле "TO" несколько адресов получателя, так как отправка будет сделана только на первый адрес.
* Сообщения отправляются в кодировке UTF-8.

Дополнительные функции: ссылка на отписку
-----------------------------------------

Вы можете добавить в письмо ссылку на отписку. Для этого необходимо в теле сообщения передавать тег *[Unsubscribe]*

Пример:
Если вы хотите отписаться от рассылки нажмите *<a href="[Unsubscribe]">здесь</a>*

Получение статистики
--------------------

Статистика по письмам отправленным через SMTP-протокол собирается аналогично статистике по рассылкам отправленным из личного кабинета. Таким образом вы сможете видеть полноценную статистику по прочитанным письмам, кол-ву переходов по ссылке, кол-ву ошибок при доставке и т.д. Статистику по транзакционным email-сообщениям вы можете получить в личном кабинете на странице "Статистика".

.. image:: /img/smtp1.jpg

Обработка ошибок
----------------

В случае возникновения ошибки при валидации email-сообщения, платформа Devino Telecom возвращает стандартный код ошибки SMTP 554 Transaction failed и текстовое описание.

Возможные описания ошибок:

+-------------------------------------------------+-------------------------------------------------+
| Текст ошибки                                    | Причина                                         |
+=================================================+=================================================+
| Must authenticate before sending mail           | Не указан, или указан некорректный логин/пароль |
+-------------------------------------------------+-------------------------------------------------+
| Internal server error                           | Ошибка сервера                                  |
+-------------------------------------------------+-------------------------------------------------+
| Not allowed attachement type <расширение файла> | Загружен запрещенный файл                       |
+-------------------------------------------------+-------------------------------------------------+
| Message exceeds fixed size limit                | Превышен допустимый размер письма               |
+-------------------------------------------------+-------------------------------------------------+
| Invalid recipient address: <адрес получателя>   | Некорректный адрес получателя                   |
+-------------------------------------------------+-------------------------------------------------+
| Disallowed source address: <адрес отправителя>  | Неподтвержденный адрес отправителя              |
+-------------------------------------------------+-------------------------------------------------+


Настройка почтового клиента Outlook
-----------------------------------

Необходимо создать учетную запись типа "IMAP/SMTP", для этого:

* Откройте Outlook
* Файл --> Добавить учетную запись
* Ручная настройка или дополнительные типы серверов --> Далее
* Протокол POP или IMAP --> Далее

Заполните поля, используя данные учетной записи любого почтового сервиса:

* Имя -  любое имя 
* Адрес электронной почты
* Тип учетной записи - IMAP
* Сервер входящей почты -  например,  imap.gmail.com 
* Сервер исходящей почты (SMTP): integrationapi.net
Пользователь/пароль - данные для входа в учетную запись --> Другие настройки --> Сервер исходящей почты -->  Smtp серверу требуется проверка подлинности --> Вход с помощью --> ввести smtp-логин и smtp-пароль --> Дополнительно --> Smtp-сервер - указать порт 587 --> Сохранить.


Отправка письма из .NET
-----------------------

.. code-block:: json	

                using System;
                using System.Diagnostics;
                using System.Net;
                using System.Net.Mail;
                namespace Devino.Email.SmtpClient
                {
                    class Program
                    {
                        static void Main(string[] args)
                        {
                            using (var smtpClient = new SmtpClient())
                            {
                                var sourceEmail = "noreplay@devinotele.com";
                                var subject = "Test from smtp";
                                var messageText = "Привет! <a href=\"http://www.devinotele.com\">Кликни меня</a>";
                                var email = "test@devinotele.com";
                                 
                                smtpClient.Host = "integrationapi.net";
                                smtpClient.Port = 587;
                                smtpClient.EnableSsl = true;
                                smtpClient.Credentials = new NetworkCredential("1website", "test");
                                
                                var message = new MailMessage(sourceEmail, email) { Sender = new MailAddress(sourceEmail), Subject = subject, Body = messageText };
                                try
                                {
                                    smtpClient.Send(message);
                                }
                                catch (Exception ex)
                                {
                                    Trace.TraceError(ex.Message);
                                }
                            }
                        }
                    }
                }
                
    
